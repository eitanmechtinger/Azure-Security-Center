{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
  "contentVersion": "1.0.0.0",
  "metadata": {
	"_generator": {
	  "name": "bicep",
	  "version": "0.5.6.12127",
	  "templateHash": "2227781763411200690"
	}
  },
  "parameters": {
	"principalId": {
	  "type": "string",
	  "metadata": {
		"description": "The principal to assign the role to"
	  }
	},
	"targetRgName": {
	  "type": "string",
	  "metadata": {
		"description": "The resource group in which the VmScanners resource will be created"
	  }
	},
	"roleNameGuid": {
	  "type": "string",
	  "defaultValue": "[newGuid()]",
	  "metadata": {
		"description": "A new GUID used to identify the role assignment"
	  }
	},
	"actions": {
	  "type": "array",
	  "defaultValue": [
		"Microsoft.Compute/disks/read",
		"Microsoft.Compute/disks/beginGetAccess/action",
		"Microsoft.Compute/virtualMachines/instanceView/read",
		"Microsoft.Compute/virtualMachines/read",
		"Microsoft.Compute/virtualMachineScaleSets/instanceView/read",
		"Microsoft.Compute/virtualMachineScaleSets/read",
		"Microsoft.Compute/virtualMachineScaleSets/virtualMachines/read",
		"Microsoft.Compute/virtualMachineScaleSets/virtualMachines/instanceView/read"
	  ],
	  "metadata": {
		"description": "Array of actions for the roleDefinition"
	  }
	},
	"notActions": {
	  "type": "array",
	  "defaultValue": [],
	  "metadata": {
		"description": "Array of notActions for the roleDefinition"
	  }
	},
	"roleName": {
	  "type": "string",
	  "defaultValue": "Custom Role - VM Scanners User",
	  "metadata": {
		"description": "Friendly name of the role definition"
	  }
	},
	"roleDescription": {
	  "type": "string",
	  "defaultValue": "Subscription Level Deployment of a Role Definition",
	  "metadata": {
		"description": "Detailed description of the role definition"
	  }
	},
	"exclusionTags": {
	  "type": "object",
	  "defaultValue": {},
	  "metadata": {
		"description": "Dictionary of string key-value pairs representing the tags used to exclude resources from being scanned. Resources tagged with one of these values will not be scanned. The values in the dictionary are case-sensitive"
	  }
	}
  },
  "variables": {
	"roleDefName": "[guid(subscription().id, string(parameters('actions')), string(parameters('notActions')))]"
  },
  "resources": [
	{
	  "type": "Microsoft.Authorization/roleDefinitions",
	  "apiVersion": "2018-07-01",
	  "name": "[variables('roleDefName')]",
	  "properties": {
		"roleName": "[parameters('roleName')]",
		"description": "[parameters('roleDescription')]",
		"type": "customRole",
		"permissions": [
		  {
			"actions": "[parameters('actions')]",
			"notActions": "[parameters('notActions')]"
		  }
		],
		"assignableScopes": [
		  "[subscription().id]"
		]
	  }
	},
	{
	  "type": "Microsoft.Authorization/roleAssignments",
	  "apiVersion": "2020-04-01-preview",
	  "name": "[parameters('roleNameGuid')]",
	  "properties": {
		"roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefName'))]",
		"principalId": "[parameters('principalId')]"
	  }
	},
	{
	  "type": "Microsoft.Resources/deployments",
	  "apiVersion": "2020-10-01",
	  "name": "vmScannersResourceRgTemplate",
	  "properties": {
		"mode": "Incremental",
		"template": {
		  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
		  "contentVersion": "1.0.0.0",
		  "resources": [
			{
			  "type": "Microsoft.Security/vmScanners",
			  "location": "westeurope",
			  "apiVersion": "2022-03-01-preview",
			  "name": "default",
			  "properties": {
				"scanningMode": "Default",
				"exclusionTags": "[parameters('exclusionTags')]"
			  }
			}
		  ]
		}
	  },
	  "resourceGroup": "[parameters('targetRgName')]"
	}
  ]
}
